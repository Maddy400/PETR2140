{% extends "base.html" %}
{% block title %}Booking Home{% endblock %}

{% block content %}
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>

<div class="container mt-4">

    <!-- Controls -->
    <div class="mb-3">
        <label for="tutor">Select Tutor:</label>
        <select id="tutor" class="form-select">
            <option value="">-- Choose Tutor --</option>
            {% for tutor in tutors %}
                <option value="{{ tutor.user_id }}">
                    {{ tutor.first_name }} {{ tutor.last_name }}
                </option>
            {% endfor %}
        </select>
    </div>

    <div class="mb-3">
        <label for="duration">Session Length:</label>
        <select id="duration" class="form-select">
            <option value="30">30 minutes</option>
            <option value="60">1 hour</option>
            <option value="90">1.5 hours</option>
        </select>
    </div>

    <div class="mb-3">
        <label for="subject">Select Subject:</label>
        <select id="subject" class="form-select">
            <option value="">-- Choose Subject --</option>
            <option value="Maths">Maths</option>
            <option value="English">English</option>
            <option value="Biology">Biology</option>
            <option value="Chemistry">Chemistry</option>
            <option value="Physics">Physics</option>
            <option value="Business">Business</option>
            <option value="Psychology">Psychology</option>
            <option value="Computer Science">Computer Science</option>
            <option value="Engineering">Engineering</option>
        </select>
    </div>

    <!-- Calendar -->
    <div id="calendar"></div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {

    let calendar = new FullCalendar.Calendar(document.getElementById('calendar'), {
        initialView: 'timeGridWeek',
        selectable: true,

        events: function(fetchInfo, successCallback) {
            let tutorId = document.getElementById('tutor').value;
            fetch(`/api/bookings?tutor_id=${tutorId}`)
                .then(res => res.json())
                .then(data => successCallback(data));
        },

        select: function(info) {
            let tutorId = document.getElementById('tutor').value;
            let duration = parseInt(document.getElementById('duration').value);

            if (!tutorId) {
                alert("Please select a tutor first");
                return;
            }

            let start = new Date(info.start);
            let subject = document.getElementById('subject').value;

            if (!subject) {
                alert("Please select a subject");
                return;
}
                
            fetch('/booking', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    start: start.toISOString(),
                    tutor_id: tutorId,
                    duration: duration,
                    subject: subject
                })
            })
            .then(res => res.json())
            .then(data => {
                if (data.error) {
                    alert(data.error);
                } else {
                    calendar.refetchEvents();
                }
            });
        }
    });

    calendar.render();

    // Refetch events when tutor changes
    document.getElementById('tutor').addEventListener('change', function() {
        calendar.refetchEvents();
    });

});
</script>
{% endblock %}